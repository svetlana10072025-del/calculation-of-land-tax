# .github/workflows/warmup-proper.yml
name: ðŸ”¥ ÐŸÑ€Ð¾Ð³Ñ€ÐµÐ² ÐºÐ°Ð»ÑŒÐºÑƒÐ»ÑÑ‚Ð¾Ñ€Ð¾Ð²

on:
  schedule:
    # ÐšÐ°Ð¶Ð´Ñ‹Ðµ 20 Ð¼Ð¸Ð½ÑƒÑ‚ Ð´Ð»Ñ ÑÐºÐ¾Ð½Ð¾Ð¼Ð¸Ð¸ Ð»Ð¸Ð¼Ð¸Ñ‚Ð¾Ð²
    - cron: '0,30 * * * *'
  workflow_dispatch:

jobs:
  warmup:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # ÐžÐ±Ñ‰Ð¸Ð¹ Ð»Ð¸Ð¼Ð¸Ñ‚ Ð½Ð° Ð²ÐµÑÑŒ job
    
    steps:
    - name: ðŸ”¥ ÐŸÑ€Ð¾Ð³Ñ€ÐµÐ²
      run: |
        echo "=== ÐŸÐ ÐžÐ“Ð Ð•Ð’ Ð—ÐÐŸÐ£Ð©Ð•Ð ==="
        echo "Ð’Ñ€ÐµÐ¼Ñ: $(date '+%H:%M:%S')"
        echo ""
        
        CALCULATORS=(
          "https://calculation-of-land-tax-4sx2mxfrtshecl77uvz7l6.streamlit.app/"
          "https://calculation-eco-tax-xfu9rozazao4heudm3p6gz.streamlit.app/"
          "https://calculation-of-excise-bnrlk8d8pnf4wpwhwvnpfj.streamlit.app/"
          "https://calculation-of-mining-tax-jvospomyc4pgvpy8ubrrrw.streamlit.app/"
          "https://calculation-of-oil-tax-fsdt98ampwhs5pzpfzuhsy.streamlit.app/"
          "https://calculation-of-tax-bfapeep5eknsp2xxs5kfij.streamlit.app/"
        )
        
        for url in "${CALCULATORS[@]}"; do
          echo "ðŸ”„ $(echo $url | cut -d'/' -f3)"
          
          # Ð£Ð²ÐµÐ»Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚ Ð´Ð¾ 120 ÑÐµÐºÑƒÐ½Ð´ Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ retry
          response=$(curl -s -L \
            -o /dev/null \
            -w "Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: %{http_code}, Ð’Ñ€ÐµÐ¼Ñ: %{time_total}Ñ\n" \
            -m 120 \          # 120 ÑÐµÐºÑƒÐ½Ð´ Ð²Ð¼ÐµÑÑ‚Ð¾ 60
            --retry 2 \       # 2 Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸ Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ°Ñ…
            --retry-delay 5 \ # ÐŸÐ°ÑƒÐ·Ð° 5 ÑÐµÐºÑƒÐ½Ð´ Ð¼ÐµÐ¶Ð´Ñƒ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ°Ð¼Ð¸
            --retry-max-time 300 \ # ÐœÐ°ÐºÑÐ¸Ð¼ÑƒÐ¼ 5 Ð¼Ð¸Ð½ÑƒÑ‚ Ð½Ð° Ð²ÑÐµ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸
            "$url?_warmup_$(date +%s)=1" 2>&1)
          
          echo "   $response"
          
          sleep 5
          echo ""
        done
        
        echo "âœ… Ð“Ð¾Ñ‚Ð¾Ð²Ð¾!"
